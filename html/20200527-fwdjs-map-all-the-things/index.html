<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Map All The Things With Mapbox GL</title>

<link rel="stylesheet" href="css/reset.css">
<link rel="stylesheet" href="css/reveal.css">
<link rel="stylesheet" href="css/theme/black.css">

<!-- Theme used for syntax highlighting of code -->
<link rel="stylesheet" href="lib/css/monokai.css">

<!-- Mapbox GL -->
<script src='https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css' rel='stylesheet' />

<style>
.map-container {
	border: 2px solid #272727;
	height: 100vh;
	left: 0;
	position: absolute;
	top: 0;
	width: 100vw;
}
</style>
</head>
<body>
	<div class="reveal">
		<div class="map-container"></div>
		<div class="slides">
			<section>
				<h1>Map All The Things</h1>
				<h2>With Mapbox GL</h2>
				<p>
					Evan Savage
				</p>

				<aside class="notes">
				</aside>
			</section>

			<section data-background-interactive>
				<h2>a map!</h2>
				<aside class="notes">
				</aside>
			</section>

			<section>
				<h2>another map!</h2>
				<aside class="notes">
				</aside>
			</section>
		</div>
	</div>
<!-- END OF SLIDES -->

<script src="js/reveal.js"></script>

<script>
const BOUNDS_TORONTO = new mapboxgl.LngLatBounds(
  new mapboxgl.LngLat(-79.639264937, 43.580995995),
  new mapboxgl.LngLat(-79.115243191, 43.855457183),
);

let map = null;
let basemapStyle = null;

async function getJson(url) {
	const response = await fetch(url);
	return response.json();
}

async function initMapbox() {
	const [root, metadata] = await Promise.all([
		getJson('data/root.json'),
		getJson('data/metadata.json'),
	]);
  basemapStyle = JSON.parse(JSON.stringify(root));
  basemapStyle.sources.esri = {
    type: 'vector',
    scheme: 'xyz',
    tilejson: metadata.tilejson || '2.0.0',
    format: (metadata.tileInfo && metadata.tileInfo.format) || 'pbf',
    maxzoom: 15,
    tiles: [
      `${basemapStyle.sources.esri.url}${metadata.tiles[0]}`,
    ],
    description: metadata.description || '',
    name: metadata.name,
  };
}

function initReveal() {
	Reveal.initialize({
		hash: true,
		dependencies: [
			{ src: 'plugin/highlight/highlight.js' },
			{ src: 'plugin/notes/notes.js', async: true }
		]
	});

	Reveal.addEventListener('slidechanged', function(evt) {
		if (map !== null) {
			map.remove();
			map = null;
		}

		if (evt.currentSlide.dataset.backgroundInteractive !== undefined) {
			const $mapContainer = document.querySelector('.slide-background:nth-child(2) > .slide-background-content');
			map = new mapboxgl.Map({
				bounds: BOUNDS_TORONTO,
				container: $mapContainer,
				keyboard: false,
				style: basemapStyle,
			});
		}
	});
}

async function main() {
	await initMapbox();
	initReveal();
}

main();
</script>
</body>
</html>
