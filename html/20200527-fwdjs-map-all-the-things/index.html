<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Map All The Things With Mapbox GL</title>

<link rel="stylesheet" href="css/reset.css">
<link rel="stylesheet" href="css/reveal.css">
<link rel="stylesheet" href="css/theme/black.css">

<!-- Theme used for syntax highlighting of code -->
<link rel="stylesheet" href="lib/css/monokai.css">

<!-- Mapbox GL -->
<script src='https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css' rel='stylesheet' />

</head>
<body>
	<div class="reveal">
		<div class="map-container"></div>
		<div class="slides">
			<section>
				<h1>Map All The Things</h1>
				<h2>With Mapbox GL</h2>
				<div class="stretch"></div>
				<p>
					<a href="https://savageevan.com/">Evan Savage</a>
				</p>

				<aside class="notes">
				</aside>
			</section>

			<section data-background-interactive data-map-id="helloWorld">
				<h2>Hello, World!</h2>
				<aside class="notes">
				</aside>
			</section>

			<section data-background-interactive data-map-id="helloToronto">
				<h2>Toronto</h2>
				<aside class="notes">
				</aside>
			</section>
		</div>
	</div>
<!-- END OF SLIDES -->

<script src="js/reveal.js"></script>

<script>
const BOUNDS_TORONTO = new mapboxgl.LngLatBounds(
  new mapboxgl.LngLat(-79.639264937, 43.580995995),
  new mapboxgl.LngLat(-79.115243191, 43.855457183),
);

let map = null;
let basemapStyle = null;

async function getJson(url) {
	const response = await fetch(url);
	return response.json();
}

async function initMapbox() {
	const [root, metadata] = await Promise.all([
		getJson('data/root.json'),
		getJson('data/metadata.json'),
	]);
  basemapStyle = JSON.parse(JSON.stringify(root));
  basemapStyle.sources.esri = {
    type: 'vector',
    scheme: 'xyz',
    tilejson: metadata.tilejson || '2.0.0',
    format: (metadata.tileInfo && metadata.tileInfo.format) || 'pbf',
    maxzoom: 15,
    tiles: [
      `${basemapStyle.sources.esri.url}${metadata.tiles[0]}`,
    ],
    description: metadata.description || '',
    name: metadata.name,
  };
}

class MapOptions {
	static _common() {
		return {
			dragRotate: false,
			pitchWithRotate: false,
			renderWorldCopies: true,
			keyboard: false,
			style: basemapStyle,
		};
	}

	static _commonToronto() {
		const bounds = BOUNDS_TORONTO;
		return {
			...MapOptions._common(),
			bounds,
			fitBoundsOptions: {
				offset: [0, -64],
			},
			maxBounds: bounds,
			minZoom: 10,
			maxZoom: 19,
			renderWorldCopies: false,
		};
	}

	static get(mapId) {
		return MapOptions[mapId]();
	}

	static getContainer() {
		const $reveal = Reveal.getRevealElement();
		const i = Reveal.getSlidePastCount() + 1;
		const selector = `.slide-background:nth-child(${i}) > .slide-background-content`;
		return $reveal.querySelector(selector);
	}

	static helloToronto() {
		return MapOptions._commonToronto();
	}

	static helloWorld() {
		return MapOptions._common();
	}
}

function removeMap() {
	if (map !== null) {
		map.remove();
		map = null;
	}
}

function loadMap() {
	const $currentSlide = Reveal.getCurrentSlide();
	const { mapId } = $currentSlide.dataset;
	console.log(mapId);
	if (mapId !== undefined) {
		const $mapContainer = MapOptions.getContainer();
		const options = MapOptions.get(mapId);
		console.log(options);
		map = new mapboxgl.Map({
			container: $mapContainer,
			...options,
		});
	}
}

function initReveal() {
	Reveal.initialize({
		center: false,
		hash: true,
		dependencies: [
			{ src: 'plugin/highlight/highlight.js' },
			{ src: 'plugin/notes/notes.js', async: true }
		]
	});

	Reveal.addEventListener('slidechanged', function(evt) {
		removeMap();
		loadMap();
	});
	Reveal.addEventListener('overviewshown', removeMap);
	Reveal.addEventListener('overviewhidden', loadMap);
}

async function main() {
	await initMapbox();
	initReveal();
}

main();
</script>
</body>
</html>
