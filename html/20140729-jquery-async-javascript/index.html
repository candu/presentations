<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAAAAABoAwAAFgAAACgAAAAQAAAAIAAAAAEAGAAAAAAAAAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAvIuwvIuwvIuwAAAMHBSguIewvIuwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAvIuwvIuwvIuwvIusvIuwvIuwvIuwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAvIuwvIuwvIuwvIusvIuwvIuwvIuwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAvIuwvIuwvIuwvIesvIuwvIuwvIuwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAjGbEvIuwvIuwvIuwvIuwvIuwvIuwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAvIuwvIuwvIuwpHtQvIuwvIuwvIuwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAvIuwvIuwvIuwvIuw1J+wvIuwvIuwvIuwvIuwAAAAAAAAAAAAAAAAAAAAAAAAvIuwvIuwvIuwvIuwcFJQAAAAQCk8vIuwvIuwvIuwvIuwAAAAAAAAAAAAAAAAAAAAvIuwvIuwvIuwAAAAeNRJoh1ZSjS1uZe0vIuwvIuwvIuwAAAAAAAAAAAAAAAAAAAAvIuwvIuwvIuwAAABDdCUBAQBRjCwLCDovIuwvIuwvIuwAAAAAAAAAAAAAAAAAAAAsIOAvIuwvIuwvIuxSjS0pRhYHCg4vIuwvIuwvIuwuIecAAAAAAAAAAAAAAAAAAAAAAAAkGtgvIuwvIuwvIusvIuwvIuwvIuwvIuwFAxkOC00AAAAAAAAAAAAAAAAAAAAAAAAvIuwjGrsvIuwuIekvIuwuJOQqHtcDAg8vIuwvIuwAAAAAAAAAAAAAAAAAAAAAAAAvIuwvIuwOCkovIuwvIuwvIuwvIuwvIuwvIuwRDGAAAAAAAAAAAAAAAAAAAAAAAAAvIuwvIuwkGrgvIuwvIuwcFI0vIuwvIuwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIBi0vIuwvIuwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADxnwAA8B8AAPAfAADwHwAA8B8AAPAfAADgDwAAw4cAAMcHAADFRwAAwYcAAOAfAADgJwAA5A8AAOCfAAD8/wAA" />
    <link rel="stylesheet" type="text/css" href="../../css/stack.css">
    <link rel="stylesheet" type="text/css" href="../../css/webfonts.css">
    <link rel="stylesheet" type="text/css" href="../../css/base.css">
    <link rel="stylesheet" type="text/css" href="css/presentation.css">

    <script src="../../js/highlight-8.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../css/solarized_dark.css">

    <script src="../../js/jquery-2.1.1.js"></script>
    <script src="../../js/underscore-1.6.0.js"></script>
    <script src="../../js/async.js"></script>
  </head>
  <body>
    <section class="center">
      <h1>Async JavaScript</h1>
      <h2>Evan Savage</h2>
      <div class="contact">
        <img src="../../img/github.png"></img>
        <a href="https://github.com/candu">candu</a>
      </div>
      <div class="contact">
        <img src="../../img/twitter.png"></img>
        <a href="https://twitter.com/candusavage">@candusavage</a>
      </div>
    </section>
    <section class="chapter center">
      <h1>before you start</h1>
    </section>
    <section class="center">
      <div class="title">Chrome users:<div>
      <h2><a target="_blank" href="https://plus.google.com/+PaulIrish/posts/T615Md5JPQG">enable Harmony!</a></h2>
    </section>
    <section class="chapter center">
      <h1>i said right this second!</h1>
    </section>
    <section>
      <blockquote>
        The minimum delay, DOM_MIN_TIMEOUT_VALUE, is 4 ms...the timeout can also fire later
        when the page (or the OS/browser itself) is busy with other tasks.
        <footer>
          &ndash; <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window.setTimeout">MDN - window.setTimeout</a>
        </footer>
      </blockquote>
    </section>
    <section class="center">
      <div class="title">timer resolution is ~4 ms</div>
      <pre><code data-code-target="#js_timer_resolution"></code></pre>
      <button id="btn_timer_resolution">run it!</button>
      <script id="js_timer_resolution">
  $('#btn_timer_resolution').click(function() {
    var start = new Date(), numCalls = 0;
    var interval = window.setInterval(function() {
      if (new Date() - start >= 1000) {
        window.clearInterval(interval);
        alert('numCalls: ' + numCalls);
      }
      numCalls++;
    }, 0);
  });
      </script>
    </section>
    <section class="center">
      <div class="title">the postMessage() trick, part 1</div>
      <pre><code data-code-target="#js_post_message"></code></pre>
      <script id="js_post_message">
  (function() {
    var callbacks = [];
    window.addEventListener('message', function(event) {
      if (event.source == window && event.data == '__zero_timeout__') {
        event.stopPropagation();
        if (callbacks.length > 0) (callbacks.shift())();
      }
    }, true);
    window.setZeroTimeout = function(callback) {
      callbacks.push(callback);
      window.postMessage('__zero_timeout__', '*');
    };
  })();
      </script>
    </section>
    <section class="center">
      <div class="title">the postMessage() trick, part 2</div>
      <pre><code data-code-target="#js_post_message_action"></code></pre>
      <button id="btn_post_message_action">run it!</button>
      <script id="js_post_message_action">
  $('#btn_post_message_action').click(function() {
    var start = new Date(), numCalls = 0;
    function callback() {
      if (new Date() - start >= 1000) {
        return alert('numCalls: ' + numCalls);
      }
      numCalls++;
      window.setZeroTimeout(callback);
    }
    window.setZeroTimeout(callback);
  });
      </script>
    </section>
    <section class="center">
      <div class="title">events wait their turn</div>
      <pre><code data-code-target="#js_timeout_waiting"></code></pre>
      <button id="btn_timeout_waiting">run it!</button>
      <script id="js_timeout_waiting">
  $('#btn_timeout_waiting').click(function() {
    var start = new Date();
    window.setTimeout(function() {
      var elapsed = new Date() - start;
      alert('elapsed: ' + elapsed + ' ms');
    }, 0);
    while (new Date() - start < 1000) {}  // busy wait...
  });
      </script>
    </section>
    <section class="center">
      <div class="title">DOM updates wait their turn</div>
      <pre><code data-code-target="#js_dom_waiting"></code></pre>
      <button id="btn_dom_waiting">run it!</button>
      <script id="js_dom_waiting">
  $('#btn_dom_waiting').click(function() {
    $('#btn_dom_waiting').css('background-color', '#f00');
    var start = new Date();
    while (new Date() - start < 1000) {}  // busy wait...
    $('#btn_dom_waiting').css('background-color', '#ff0');
  });
      </script>
    </section>
    <section class="center">
      <div class="title">the setTimeout(..., 0) trick</div>
      <pre><code data-code-target="#js_dom_waiting_fixed"></code></pre>
      <button id="btn_dom_waiting_fixed">run it!</button>
      <script id="js_dom_waiting_fixed">
  $('#btn_dom_waiting_fixed').click(function() {
    $('#btn_dom_waiting_fixed').css('background-color', '#f00');
    var start = new Date();
    window.setTimeout(function() {
      while (new Date() - start < 1000) {}  // busy wait...
      $('#btn_dom_waiting_fixed').css('background-color', '#ff0');
    }, 0);
  });
      </script>
    </section>
    <section class="center">
      <div class="title">events are queued, part 1</div>
      <pre><code data-code-target="#js_event_queue"></code></pre>
      <button id="btn_event_queue">run it!</button>
      <div id="output_event_queue"></div>
      <script id="js_event_queue">
  $('#btn_event_queue').click(function() {
    $('#output_event_queue').empty();
    _.each(_.range(10), function(i) {
      window.setTimeout(function() {
        var start = new Date(), wait = Math.floor(200 * Math.random());
        while (new Date() - start < wait) {}  // busy wait...
        $('<span />').text(i).appendTo($('#output_event_queue'));
      }, 0);
    })
  });
      </script>
    </section>
    <section class="center">
      <div class="title">events are queued, part 2</div>
      <pre><code data-code-target="#js_event_queue_fixed"></code></pre>
      <button id="btn_event_queue_fixed">run it!</button>
      <div id="output_event_queue_fixed"></div>
      <script id="js_event_queue_fixed">
  $('#btn_event_queue_fixed').click(function() {
    $('#output_event_queue_fixed').empty();
    _.each(_.range(10), function(i) {
      var wait = Math.floor(200 * Math.random());
      window.setTimeout(function() {
        var start = new Date();
        $('<span />').text(i).appendTo($('#output_event_queue_fixed'));
      }, wait);  // timeout wait...
    })
  });
      </script>
    </section>
    <section class="chapter center">
      <h1>i'll have my people call your people</h1>
    </section>
    <section class="center">
      <div class="title">$.ajax(), old-style</div>
      <pre><code data-code-target="#js_ajax_old_style"></code></pre>
      <button id="btn_ajax_old_style">run it!</button>
      <script id="js_ajax_old_style">
  function alertJSON(value) {
    alert(JSON.stringify(value));
  }
  $('#btn_ajax_old_style').click(function() {
    $.getJSON('json/a.json', alertJSON);
  });
      </script>
    </section>
    <section class="center">
      <div class="title">the pyramid of doom</div>
      <pre><code data-code-target="#js_pyramid_of_doom"></code></pre>
      <button id="btn_pyramid_of_doom">run it!</button>
      <script id="js_pyramid_of_doom">
  $('#btn_pyramid_of_doom').click(function() {
    $.getJSON('json/a.json', function(a) {
      $.getJSON('json/b.json', function(b) {
        $.getJSON('json/c.json', function(c) {
          alertJSON([a, b, c]);
        });
      });
    });
  });
      </script>
    </section>
    <section class="center">
      <div class="title">named callbacks</div>
      <pre><code data-code-target="#js_named_callbacks"></code></pre>
      <button id="btn_named_callbacks">run it!</button>
      <script id="js_named_callbacks">
  function a(doneA, doneB) {
    $.getJSON('json/a.json', function(a) { doneA(a, doneB); }); }
  function b(a, doneB) {
    $.getJSON('json/b.json', function(b) { doneB(a, b); }); }
  function c(a, b) {
    $.getJSON('json/c.json', function(c) {
      alertJSON([a, b, c]);
    }); }
  $('#btn_named_callbacks').click(function() { a(b, c) });
      </script>
    </section>
    <section class="center">
      <div class="title">DIY series execution</div>
      <pre><code data-code-target="#js_series_execution"></code></pre>
      <button id="btn_series_execution">run it!</button>
      <script id="js_series_execution">
  var urls = _.map('abc', function(x) { return 'json/' + x + '.json'; });

  function series(urls, done) {
    if (urls.length === 0) done([]);
    $.getJSON(urls[0], function(first) {
      series(urls.slice(1), function(rest) {
        done([first].concat(rest)); }); }); };
  $('#btn_series_execution').click(function() {
    series(urls, alertJSON) });
      </script>
    </section>
    <section class="center">
      <div class="title">DIY parallel execution</div>
      <pre><code data-code-target="#js_parallel_execution"></code></pre>
      <button id="btn_parallel_execution">run it!</button>
      <script id="js_parallel_execution">
  function parallel(urls, done) {
    if (urls.length === 0) { done([]); }
    var numDone = 0, n = urls.length, results = new Array(n);
    _.each(urls, function(url, i) {
      $.getJSON(url, function(result) {
        results[i] = result;
        if (++numDone === n) done(results); }); }); }
  $('#btn_parallel_execution').click(function() {
    parallel(urls, alertJSON); });
      </script>
    </section>
    <section class="chapter center">
      <h1>everything but the kitchen async</h1>
    </section>
    <section class="center">
      <div class="title">node-style callbacks</div>
      <pre><code data-code-target="#js_node_callbacks"></code></pre>
      <button id="btn_node_callbacks">run it!</button>
      <script id="js_node_callbacks">
  function task(url) {
    return function(callback) {
      $.getJSON(url, function(result) { callback(null, result); });
    };
  }
  $('#btn_node_callbacks').click(function() {
    task('json/a.json')(function(err, a) { alertJSON(a); });
  });
      </script>
    </section>
    <section class="center">
      <div class="title">async.series()</div>
      <pre><code data-code-target="#js_series_async"></code></pre>
      <button id="btn_series_async">run it!</button>
      <script id="js_series_async">
  $('#btn_series_async').click(function() {
    async.series(_.map(urls, task), function(err, abc) {
      alertJSON(abc);
    });
  });
      </script>
    </section>
    <section class="center">
      <div class="title">async.parallel()</div>
      <pre><code data-code-target="#js_parallel_async"></code></pre>
      <button id="btn_parallel_async">run it!</button>
      <script id="js_parallel_async">
  $('#btn_parallel_async').click(function() {
    async.parallel(_.map(urls, task), function(err, abc) {
      alertJSON(abc);
    });
  });
      </script>
    </section>
    <section class="chapter center">
      <h1>i'll be back, i promise</h1>
    </section>
    <section class="center">
      <div class="title">$.ajax(), new-style</div>
      <pre><code data-code-target="#js_ajax_new_style"></code></pre>
      <button id="btn_ajax_new_style">run it!</button>
      <script id="js_ajax_new_style">
  /* old-style:
   *
   * $.getJSON('json/a.json', function(a) {
   *   alert(JSON.stringify(a));
   * });
   */
  $('#btn_ajax_new_style').click(function() {
    $.getJSON('json/a.json').done(alertJSON);
  });
      </script>
    </section>
    <section class="center">
      <div class="title">deferreds and promises</div>
      <pre><code data-code-target="#js_deferreds"></code></pre>
      <button id="btn_deferreds">run it!</button>
      <script id="js_deferreds">
  function getJsonNew(url) {
    var d = new $.Deferred();
    $.getJSON(url, d.resolve.bind(d));
    return d.promise();
  }
  $('#btn_deferreds').click(function() {
    getJsonNew('json/a.json').done(alertJSON);
  });
      </script>
    </section>
    <section class="center">
      <div class="title">DIY promises, part 1</div>
      <pre><code data-code-target="#js_promises"></code></pre>
      <script id="js_promises">
  var Promise = function() {
    this._callbacks = [];
    this._done = false;
  };
  Promise.prototype.resolve = function(value) {
    this._done = true;
    this._value = value;
    _.each(this._callbacks, function(callback) {
      callback(value); });
    return this; };
  Promise.prototype.done = function(callback) {
    if (this._done) return callback(this._value);
    this._callbacks.push(callback);
    return this; };
      </script>
    </section>
    <section class="center">
      <div class="title">DIY promises, part 2</div>
      <pre><code data-code-target="#js_promises_action"></code></pre>
      <button id="btn_promises_action">run it!</button>
      <script id="js_promises_action">
  function getJsonDiyPromise(url) {
    var p = new Promise();
    $.getJSON(url, p.resolve.bind(p));
    return p;
  };
  $('#btn_promises_action').click(function() {
    getJsonDiyPromise('json/a.json').done(alertJSON);
  });
      </script>
    </section>
    <section class="center">
      <div class="title">Promise.all()</div>
      <pre><code data-code-target="#js_promises_all"></code></pre>
      <button id="btn_promises_all">run it!</button>
      <script id="js_promises_all">
  Promise.all = function(ps) {
    var P = new Promise();
    if (ps.length === 0) { P.resolve([]); }
    var numDone = 0, n = ps.length, results = new Array(n);
    _.each(ps, function(p, i) {
      p.done(function(result) {
        results[i] = result;
        if (++numDone === n) P.resolve(results); }); });
    return P; };
  $('#btn_promises_all').click(function() {
    var ps = _.map(urls, getJsonDiyPromise);
    Promise.all(ps).done(alertJSON); });
      </script>
    </section>
    <section class="chapter center">
      <h1>what's the big event?</h1>
    </section>
    <section class="center">
      <div class="title">$.on(), $.trigger()</div>
      <pre><code data-code-target="#js_jquery_custom_events"></code></pre>
      <button id="btn_jquery_custom_events">run it!</button>
      <script id="js_jquery_custom_events">
  $('#btn_jquery_custom_events').on('foo', function() {
    alert('foo');
  }).click(function() {
    window.setTimeout(function() {
      $('#btn_jquery_custom_events').trigger('foo');
    }, 1000);
  });
      </script>
    </section>
    <section class="center">
      <div class="title">DIY event dispatcher, part 1</div>
      <pre><code data-code-target="#js_event_dispatcher"></code></pre>
      <script id="js_event_dispatcher">
  var EventDispatcher = function() {
    this._callbacks = {}; };
  EventDispatcher.prototype.trigger = function(type /* arg, ... */) {
    if (!_.has(this._callbacks, type)) return;
    var args = Array.prototype.slice.call(arguments, 1);
    _.each(this._callbacks[type], function(callback) {
      callback.apply(null, args); }); };
  EventDispatcher.prototype.on = function(type, callback) {
    if (!_.has(this._callbacks, type)) {
      this._callbacks[type] = [];
    }
    this._callbacks[type].push(callback); };
      </script>
    </section>
    <section class="center">
      <div class="title">DIY event dispatcher, part 2</div>
      <pre><code data-code-target="#js_event_dispatcher_action"></code></pre>
      <button id="btn_event_dispatcher_action">run it!</button>
      <script id="js_event_dispatcher_action">
  var dispatcher = new EventDispatcher();
  dispatcher.on('foo', function() {
    alert('foo');
  });
  $('#btn_event_dispatcher_action').click(function() {
    window.setTimeout(function() {
      dispatcher.trigger('foo');
    }, 1000);
  });
      </script>
    </section>
    <section class="center">
      <div class="title">event evaluation is synchronous</div>
      <pre><code data-code-target="#js_event_dom_waiting"></code></pre>
      <button id="btn_event_dom_waiting">run it!</button>
      <script id="js_event_dom_waiting">
  dispatcher.on('bar', function() {
    $('#btn_event_dom_waiting').css('background-color', '#ff0');
  });
  $('#btn_event_dom_waiting').click(function() {
    $('#btn_event_dom_waiting').css('background-color', '#f00');
    var start = new Date();
    while (new Date() - start < 1000) {}  // busy wait...
    dispatcher.trigger('bar');
  });
      </script>
    </section>
    <section class="chapter center">
      <h1>alright, i yield!</h1>
    </section>
    <section class="center">
      <div class="title">ES6 generators</div>
      <pre><code data-code-target="#js_generators"></code></pre>
      <button id="btn_generators">run it!</button>
      <script id="js_generators">
  function* genIdMaker() {
    var nextId = 0;
    while (true) {
      yield nextId++;
    }
  }
  var idMaker = genIdMaker();
  $('#btn_generators').click(function() {
    alert('nextId: ' + idMaker.next().value);
  });
      </script>
    </section>
    <section class="center">
      <div class="title">generators from promises</div>
      <pre><code data-code-target="#js_generators_from_promises"></code></pre>
      <button id="btn_generators_from_promises">run it!</button>
      <script>
var GenPromise = function(p) {
  this._p = p;
  this._g = this._createGenerator();
  this._p.done(function(result) {
    this._g.next(result);
  }.bind(this));
};
GenPromise.prototype._createGenerator = function*() {
  var result = yield null;
  yield result;
};
GenPromise.prototype.gen = function() {
  return this._g;
};
function gen(url) {
  return new GenPromise($.getJSON(url)).gen();
}
      </script>
      <script id="js_generators_from_promises">
  var genABCSeries = function*() {
    var a = yield* gen('json/a.json');
    var b = yield* gen('json/b.json');
    var c = yield* gen('json/c.json');
    yield [a, b, c];
  };
  $('#btn_generators_from_promises').click(function() {
    var abc = genABCSeries().next().value;
    alertJSON(abc);
  });
      </script>
    </section>
    <section class="center">
      <div class="title">genAll()</div>
      <pre><code data-code-target="#js_gen_all"></code></pre>
      <button id="btn_gen_all">run it!</button>
      <script id="js_gen_all">
  function genAll(gens) {
  }
  $('#btn_gen_all').click(function*() {
    var results = yield genAll(_.map(urls, gen));
    alertJSON(results);
  });
      </script>
    </section>
    <section class="center">
      <div class="title">generators from callbacks</div>
      <pre><code data-code-target="#js_generators_from_callbacks"></code></pre>
      <button id="btn_generators_from_callbacks">run it!</button>
      <script id="js_generators_from_callbacks">
  function genCallback(fn) {
    // TODO: this
  }
  $('#btn_generators_from_callbacks').click(function*() {
    var a = yield genCallback(task('json/a.json'));
    alertJSON(a);
  });
      </script>
    </section>
    <section class="center">
      <div class="title">DIY generators?</div>
      <h2><a href="#">sort of</a></h2>
    </section>
    <section class="chapter center">
      <h1>further reading</h1>
    </section>
    <section>
      <ul>
        <li>TODO: this</li>
      </ul>
    </section>
    <section class="center">
      <h1>Async JavaScript</h1>
      <h2>Evan Savage</h2>
      <div class="contact">
        <img src="../../img/github.png"></img>
        <a href="https://github.com/candu">candu</a>
      </div>
      <div class="contact">
        <img src="../../img/twitter.png"></img>
        <a href="https://twitter.com/candusavage">@candusavage</a>
      </div>
    </section>
    <!-- stack.js -->
    <script src="../../js/d3.js?2.7.3"></script>
    <script src="../../js/stack.js"></script>
    <!-- highlighting -->
    <script>
    $(document).ready(function() {
      $('pre > code').each(function(i, block) {
        var codeTarget = $(block).data('codeTarget');
        $(block).text($(codeTarget).html());
        hljs.highlightBlock(block);
      });
    });
    </script>
  </body>
</html>
